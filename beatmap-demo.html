<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ‚æ‹æ£€æµ‹æ¼”ç¤º - Beat Detection Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .description {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #visualizer {
            width: 100%;
            height: 200px;
            background: #000;
            border-radius: 10px;
            margin: 20px 0;
        }

        #beatIndicator {
            width: 100px;
            height: 100px;
            background: #ccc;
            border-radius: 50%;
            margin: 20px auto;
            transition: all 0.1s;
        }

        #beatIndicator.beat {
            background: #f39c12;
            transform: scale(1.2);
            box-shadow: 0 0 30px #f39c12;
        }

        .info-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .info-box label {
            font-weight: bold;
            color: #667eea;
            margin-right: 10px;
        }

        .info-box span {
            font-size: 24px;
            color: #333;
        }

        .beat-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .beat-marker {
            width: 30px;
            height: 30px;
            background: #667eea;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .explanation {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #2196f3;
        }

        .explanation h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .explanation ul {
            margin-left: 20px;
            line-height: 1.8;
        }

        input[type="file"] {
            margin: 10px 0;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        #sensitivity {
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ èŠ‚æ‹æ£€æµ‹æ¼”ç¤º</h1>
        <p class="description">
            è¿™ä¸ªå·¥å…·æ¼”ç¤ºäº†å¦‚ä½•ä»éŸ³é¢‘ä¸­è‡ªåŠ¨æ£€æµ‹èŠ‚æ‹ã€‚ä½ å¯ä»¥ä½¿ç”¨éº¦å…‹é£è¾“å…¥æˆ–ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼Œ
            ç³»ç»Ÿä¼šåˆ†æéŸ³é¢‘å¹¶å°è¯•æ‰¾å‡ºèŠ‚å¥ç‚¹ã€‚
        </p>

        <div class="section">
            <h2>1. é€‰æ‹©éŸ³é¢‘æº</h2>
            <div class="controls">
                <button id="micBtn">ä½¿ç”¨éº¦å…‹é£</button>
                <button id="demoBtn">æ’­æ”¾ç¤ºä¾‹éŸ³ä¹</button>
                <button id="stopBtn" disabled>åœæ­¢</button>
                <div>
                    <label>çµæ•åº¦:</label>
                    <input type="range" id="sensitivity" min="10" max="100" value="40">
                    <span id="sensitivityValue">40</span>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>2. éŸ³é¢‘å¯è§†åŒ–</h2>
            <canvas id="visualizer"></canvas>
            <div id="beatIndicator"></div>
            <div class="info-box">
                <label>æ£€æµ‹åˆ°çš„BPM:</label>
                <span id="bpmDisplay">--</span>
            </div>
            <div class="info-box">
                <label>æ£€æµ‹åˆ°çš„èŠ‚æ‹:</label>
                <span id="beatCount">0</span>
                <div class="beat-list" id="beatList"></div>
            </div>
        </div>

        <div class="explanation">
            <h3>ğŸ’¡ è¿™æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</h3>
            <ul>
                <li><strong>éŸ³é¢‘åˆ†æï¼š</strong>ä½¿ç”¨Web Audio APIçš„AnalyserNodeæ¥è·å–éŸ³é¢‘çš„é¢‘ç‡å’ŒæŒ¯å¹…æ•°æ®</li>
                <li><strong>èƒ½é‡æ£€æµ‹ï¼š</strong>è®¡ç®—éŸ³é¢‘çš„æ€»èƒ½é‡ï¼ˆæ‰€æœ‰é¢‘ç‡çš„æŒ¯å¹…ä¹‹å’Œï¼‰</li>
                <li><strong>å³°å€¼æ£€æµ‹ï¼š</strong>å½“èƒ½é‡çªç„¶å‡é«˜ï¼ˆè¶…è¿‡å¹³å‡å€¼+é˜ˆå€¼ï¼‰æ—¶ï¼Œè®¤ä¸ºæ˜¯ä¸€ä¸ªèŠ‚æ‹ç‚¹</li>
                <li><strong>BPMè®¡ç®—ï¼š</strong>æ ¹æ®èŠ‚æ‹ä¹‹é—´çš„æ—¶é—´é—´éš”è®¡ç®—æ¯åˆ†é’Ÿçš„èŠ‚æ‹æ•°</li>
                <li><strong>å±€é™æ€§ï¼š</strong>è¿™ç§ç®€å•ç®—æ³•åªèƒ½æ£€æµ‹æ˜æ˜¾çš„èŠ‚æ‹ï¼Œå¤æ‚éŸ³ä¹éœ€è¦æ›´é«˜çº§çš„ç®—æ³•</li>
            </ul>
        </div>

        <div class="explanation" style="background: #fff3cd; border-left-color: #ffc107;">
            <h3>âš ï¸ çœŸå®æ¸¸æˆä¸­çš„åˆ¶è°±</h3>
            <ul>
                <li><strong>OSU!</strong> - å®Œå…¨äººå·¥åˆ¶è°±ï¼Œç¤¾åŒºä¸Šä¼ è°±é¢</li>
                <li><strong>èŠ‚å¥å¤§å¸ˆ</strong> - ä¸“ä¸šè°±å¸ˆæ‰‹å·¥åˆ¶ä½œæ¯é¦–æ­Œçš„è°±é¢</li>
                <li><strong>Beat Saber</strong> - è°±é¢ç¼–è¾‘å™¨ + äººå·¥è°ƒæ•´</li>
                <li><strong>Auditionï¼ˆåŠ²èˆå›¢ï¼‰</strong> - æ ¹æ®éŸ³ä¹çš„é¼“ç‚¹ã€æ—‹å¾‹ã€äººå£°ç²¾å¿ƒè®¾è®¡</li>
                <li>è‡ªåŠ¨æ£€æµ‹åªèƒ½ä½œä¸º<strong>è¾…åŠ©å·¥å…·</strong>ï¼Œæœ€ç»ˆè´¨é‡è¿˜æ˜¯è¦é äººå·¥è°ƒæ•´ï¼</li>
            </ul>
        </div>
    </div>

    <script>
        let audioContext;
        let analyser;
        let dataArray;
        let bufferLength;
        let source;
        let animationId;
        let isRunning = false;

        let beatTimes = [];
        let lastBeatTime = 0;
        let energyHistory = [];
        let sensitivity = 40;

        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = 200;

        const beatIndicator = document.getElementById('beatIndicator');
        const bpmDisplay = document.getElementById('bpmDisplay');
        const beatCountDisplay = document.getElementById('beatCount');
        const beatList = document.getElementById('beatList');

        document.getElementById('sensitivity').addEventListener('input', (e) => {
            sensitivity = parseInt(e.target.value);
            document.getElementById('sensitivityValue').textContent = sensitivity;
        });

        document.getElementById('micBtn').addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                initAudio(stream);
            } catch (error) {
                alert('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message);
            }
        });

        document.getElementById('demoBtn').addEventListener('click', () => {
            initDemoAudio();
        });

        document.getElementById('stopBtn').addEventListener('click', () => {
            stopAudio();
        });

        function initAudio(stream) {
            if (audioContext) {
                audioContext.close();
            }

            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;

            bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);

            source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);

            isRunning = true;
            beatTimes = [];
            energyHistory = [];

            document.getElementById('micBtn').disabled = true;
            document.getElementById('demoBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;

            visualize();
        }

        function initDemoAudio() {
            if (audioContext) {
                audioContext.close();
            }

            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;

            bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);

            // åˆ›å»ºä¸€ä¸ªç®€å•çš„èŠ‚å¥éŸ³ä¹
            const bpm = 120;
            const beatInterval = 60 / bpm;

            playDemoBeat(beatInterval);

            isRunning = true;
            beatTimes = [];
            energyHistory = [];

            document.getElementById('micBtn').disabled = true;
            document.getElementById('demoBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;

            visualize();
        }

        function playDemoBeat(beatInterval) {
            const now = audioContext.currentTime;

            // æ’­æ”¾30ç§’çš„ç¤ºä¾‹èŠ‚æ‹
            for (let i = 0; i < 60; i++) {
                const time = now + i * beatInterval;
                playKick(time);
                if (i % 4 === 2) {
                    playSnare(time);
                }
            }
        }

        function playKick(time) {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();

            osc.frequency.value = 150;
            osc.type = 'sine';

            gain.gain.setValueAtTime(1, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.5);

            osc.connect(gain);
            gain.connect(analyser);
            analyser.connect(audioContext.destination);

            osc.start(time);
            osc.stop(time + 0.5);
        }

        function playSnare(time) {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();

            osc.frequency.value = 200;
            osc.type = 'triangle';

            gain.gain.setValueAtTime(0.5, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.2);

            osc.connect(gain);
            gain.connect(analyser);

            osc.start(time);
            osc.stop(time + 0.2);
        }

        function visualize() {
            if (!isRunning) return;

            animationId = requestAnimationFrame(visualize);

            analyser.getByteFrequencyData(dataArray);

            // ç»˜åˆ¶é¢‘è°±
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const barWidth = (canvas.width / bufferLength) * 2.5;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                const barHeight = (dataArray[i] / 255) * canvas.height;

                const hue = (i / bufferLength) * 360;
                ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

                x += barWidth + 1;
            }

            // èŠ‚æ‹æ£€æµ‹
            detectBeat();
        }

        function detectBeat() {
            // è®¡ç®—å½“å‰èƒ½é‡
            let energy = 0;
            for (let i = 0; i < bufferLength; i++) {
                energy += dataArray[i];
            }
            energy = energy / bufferLength;

            // ä¿å­˜èƒ½é‡å†å²
            energyHistory.push(energy);
            if (energyHistory.length > 50) {
                energyHistory.shift();
            }

            // è®¡ç®—å¹³å‡èƒ½é‡
            const avgEnergy = energyHistory.reduce((a, b) => a + b, 0) / energyHistory.length;

            // æ£€æµ‹å³°å€¼
            const threshold = avgEnergy + sensitivity;
            const now = Date.now();

            if (energy > threshold && now - lastBeatTime > 200) {
                onBeatDetected();
                lastBeatTime = now;
            }
        }

        function onBeatDetected() {
            const now = Date.now();
            beatTimes.push(now);

            // åªä¿ç•™æœ€è¿‘çš„20ä¸ªèŠ‚æ‹
            if (beatTimes.length > 20) {
                beatTimes.shift();
            }

            // è®¡ç®—BPM
            if (beatTimes.length >= 2) {
                const intervals = [];
                for (let i = 1; i < beatTimes.length; i++) {
                    intervals.push(beatTimes[i] - beatTimes[i - 1]);
                }
                const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
                const bpm = Math.round(60000 / avgInterval);
                bpmDisplay.textContent = bpm;
            }

            // è§†è§‰åé¦ˆ
            beatIndicator.classList.add('beat');
            setTimeout(() => {
                beatIndicator.classList.remove('beat');
            }, 100);

            // æ›´æ–°èŠ‚æ‹è®¡æ•°
            beatCountDisplay.textContent = beatTimes.length;

            // æ·»åŠ èŠ‚æ‹æ ‡è®°
            const marker = document.createElement('div');
            marker.className = 'beat-marker';
            marker.textContent = beatTimes.length;
            beatList.appendChild(marker);

            // åªä¿ç•™æœ€è¿‘20ä¸ªæ ‡è®°
            while (beatList.children.length > 20) {
                beatList.removeChild(beatList.firstChild);
            }
        }

        function stopAudio() {
            isRunning = false;

            if (animationId) {
                cancelAnimationFrame(animationId);
            }

            if (source) {
                source.disconnect();
            }

            if (audioContext) {
                audioContext.close();
            }

            document.getElementById('micBtn').disabled = false;
            document.getElementById('demoBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
    </script>
</body>
</html>
